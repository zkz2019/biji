
<!-- 兼容 -->
<template></template>

<script>
/**
      - 判断本地录入机驱动是否安装;
      - 本地录入机循环请求,如果3次后还提示未安装驱动就取消循环;
      - 如果本地录入机驱动已安装则调用本地录入机方法;
      - 如果本地录入机驱动未安装则调用友我方法;
      - 如果友我驱动也未安装则暴露本地录入机驱动下载;
        */

// f6ced2卡片
// f6ced1身份证
// f6ceda指纹
// {"resultCode":"01","resultMsg":"未找到录入机设备信息！","result":""}

// let obj = {
//               CardNo: result.codetype, //返回的参数
//               types: "0",              //参数类型(0-卡片,1-指纹,2-身份证)
//               FunctionID: 0,           //老参数类型(写死为1-卡片\3-身份证)
//               Result: 1,               //老的参数(写死为1即可);
//               err: false               //错误码(0-正常,1-未插入录入机,2-数据为空)
//             };
import { getcode, delcode, rgetcode } from "@/utils/read.js";
import { loadScript } from "@/utils/utils.js";
import setting from "@/setting.js";
export default {
  props: {
    close: Boolean, //应该是弹框的显示隐藏参数;
    type: {
      type: String | Number,
      default: 0
    },
    types: {
      //需要返回卡片/指纹/身份证数据;(0-卡片,1-指纹,2-身份证,""-不指定)
      type: String | Number,
      default: ""
    },
    next: {
      //是否返回空数据
      type: Boolean,
      default: false
    },
    MustLocal: {
      //是否只使用本地录入机
      type: Boolean,
      default: false
    }
  },
  data() {
    return {
      isInstall: false,
      sectors: [],
      adyjk: true,
      rfidreader: null,
      showtemp: 0, //调用本地或友我,0-等待(判断中);1-本地;2-友我;
      judgeTimes: null, //判断本地录入机是否存在的定时器;
      Times1: null, //本地录入机定时器
      // Times2: null,
      // Timeouts: null,
      firstnext: true // 防止created和activated同时触发调用两次;(初始化本地录入机的时候也用到了,防止程序已运行至judgeInstall时销毁页面导致无法清除定时器)
    };
  },
  created() {
    this.judgeInstall();
    this.firstnext = false;
  },
  activated() {
    this.judgeInstall();
    this.firstnext = false;
    // this.clearInter();
    // this.Times2 = setInterval(() => {
    //   this.getResult();
    // }, 1000);
  },
  beforeDestroy() {
    this.exits();
    // clearInterval(this.judgeTimes);
    this.clearInterJudge();
    this.adyjk = false;
    this.disconnect();
  },
  deactivated() {
    this.exits();
  },
  watch: {
    close() {
      if (this.close) {
        this.judgeInstall(true);
      } else {
        this.adyjk = false;
        this.disconnect();
      }
    }
  },
  methods: {
    exits() {
      if (this.showtemp == 1) {
        this.adyjk = false;
        this.delResult();
        this.clearInter();
      } else if (this.showtemp == 2) {
        this.adyjk = false;
        this.disconnect();
      }
      this.firstnext = true;
    },
    judgeInstall(close = false) {
      //判断驱动下载情况;
      if (!this.firstnext) {
        return;
      }
      if (this.MustLocal) {
        //判断是否只使用本地录入机
        this.showtemp = 1;
        // this.initLocal();
        this.judgeInstall(true);
      } else {
        this.judgeInstall(false);
      }
    },
    judgeInstall(isLocal) {
      let num = 0;
      if (this.judgeTimes) {
        this.clearInterJudge();
      }
      this.judgeTimes = setInterval(() => {
        num++;
        // 判断本地录入机驱动是否存在
        getcode(
          res => {
            this.clearInterJudge();
            // clearInterval(this.judgeTimes);
            this.showtemp = 1;
            this.initLocal();
          },
          err => {
            // 本地驱动不存在则执行友我的方法
            if (num > 3) {
              if (isLocal) {
                this.clearInterJudge();
                this.clearInter();
              } else {
                this.clearInter();
                this.showtemp = 2;
                this.initYowo(close);
                // clearInterval(this.judgeTimes);
                this.clearInterJudge();
              }
            }
            // this.delResult();
          }
        );
      }, 1000);
    },
    initYowo(close) {
      // 初始化友我服务
      if (close) {
        this.adyjk = true;
        this.jzjs(() => {
          if (this.adyjk) {
            this.isInstall = false;
            this.$emit("onInstall", false);
            window.setTimeout(() => {
              this.judgeLoad();
            }, 5000);
          }
        });
      } else {
        this.jzjs(() => {
          this.isInstall = false;
          this.$emit("onInstall", false);
        });
      }
    },
    initLocal() {
      // 初始化本地录入机服务
      this.clearInter();
      this.Times1 = setInterval(() => {
        if (this.firstnext) {
          this.clearInter();
        }
        this.getResult();
      }, 1000);
      this.delResult();
    },
    clearInter() {
      clearInterval(this.Times1);
      // clearInterval(this.Times2);
    },
    clearInterJudge() {
      clearInterval(this.judgeTimes);
      this.judgeTimes = null;
    },
    delResult() {
      // 清空录入机数据
      delcode(
        res => {},
        err => {
          console.log("err", err);
        }
      );
    },
    getResult() {
      //循环获取数据
      getcode(
        res => {
          let result = res.result;
          console.log("循环获取数据", res, result);
          this.$emit("onInstall", true);
          if (res.resultCode == "01") {
            console.log("错误抛出01");
            this.$emit("resultdata", {
              err: 1
            });
          } else if (res.resultCode == "0") {
            this.handleResult(result);
          }
          this.delResult();
        },
        err => {
          this.delResult();
          this.$emit("onInstall", false);
        }
      );
    },
    rgetResult() {
      //手动重新获取数据
      rgetcode(
        res => {
          let result = res.result;
          console.log("手动重新获取数据", result);
          this.$emit("onInstall", true);
          if (res.resultCode == "21") {
            console.log("错误抛出21");
            this.$emit("resultdata", {
              err: 1
            });
            this.$message({
              type: "error",
              message: "未找到录入机设备信息！"
            });
          } else if (res.resultCode == "0") {
            this.handleResult(result);
          }
          this.delResult();
        },
        err => {
          this.delResult();
          this.$emit("onInstall", false);
        }
      );
    },
    download() {
      //下载安装包
      window.location = window.location.origin + "/download/keenzy_cs_x64.exe";
    },
    handleResult(result) {
      // 处理数据
      if (result !== "") {
        console.log("获得result", result);
        if (result.codetype == "f6ced2") {
          if (this.types === "" || this.types === "0") {
            let obj = {
              CardNo: result.codecontent,
              types: "0",
              FunctionID: 0,
              Result: 1,
              err: 0
            };
            console.log("数据抛出", obj);
            this.$emit("resultdata", obj);
          } else {
            this.$message({
              showClose: true,
              message: "请勿读取卡号!"
              // type: "error"
            });
          }
        } else if (result.codetype == "f6ceda") {
          if (this.types === "" || this.types === "1") {
            let obj = {
              CardNo: result.codecontent,
              types: "1",
              FunctionID: 0,
              err: 0,
              Result: 1
            };
            console.log("指纹", obj);
            this.$emit("resultdata", obj);
          } else {
            this.$message({
              showClose: true,
              message: "请勿读取指纹!"
              // type: "error"
            });
          }
        } else if (result.codetype == "f6ced1") {
          if (this.types === "" || this.types === "2") {
            let obj = {
              CardNo: result.codecontent,
              types: "2",
              FunctionID: 3,
              err: 0,
              Result: 1
            };
            console.log("身份证", obj);
            this.$emit("resultdata", obj);
          } else {
            this.$message({
              showClose: true,
              message: "请勿读取身份证!"
              // type: "error"
            });
          }
        }
      } else {
        if (this.next) {
          let obj = {
            CardNo: result.codecontent,
            types: "",
            FunctionID: 0,
            err: 2,
            Result: 0
          };
          console.log("空数据抛出", this.next);
          this.$emit("resultdata", obj);
        }
      }
    },
    readIDCard() {
      //重新获取
      console.log("重新获取");
      if (this.showtemp == 1) {
        this.rgetResult();
      } else if (this.showtemp == 2) {
        this.tips(
          () => {
            this.rfidreader.Repeat = 0;
            this.rfidreader.HaltAfterSuccess = 0;
            this.rfidreader.RequestChinaIDCardNo();
          },
          () => {
            this.$message({
              showClose: true,
              message: "未找到录入机驱动,请先安装！",
              type: "error"
            });
          }
        );
      }
    },

    /*
==-----------------------------------------------------------------==
-====================上=本地录入机方法======下=友我方法================
---------------------------------------------------------------------
*/

    tips(callback, errCallback) {
      if (this.isInstall) {
        if (callback) {
          callback();
        }
      } else {
        this.jzjs(errCallback, callback);
      }
    },
    // download() {
    //   window.location = "/download/YOWORFIDReaderCloudForWeb.exe";
    //   window.setTimeout(() => {
    //     this.judgeLoad();
    //   }, 10000);
    // },
    jzjs(callback, Success) {
      if (this.$config.system.name == "windows") {
        if (typeof YOWORFIDReader == "undefined") {
          loadScript(
            "http://127.0.0.1:8008/YOWOCloudRFIDReader.js",
            () => {
              this.loadExe();
              if (Success) {
                Success();
              }
            },
            () => {
              if (callback) {
                callback();
              }
            }
          );
        } else {
          this.init();
        }
      } else {
        setTimeout(() => {
          this.$message({
            showClose: true,
            message:
              "当前系统不支持友我科技RFID云服务，不能读写卡！目前只支持windows系统",
            type: "error"
          });
        }, 1000);
      }
    },
    judgeLoad() {
      this.jzjs(() => {
        if (this.adyjk) {
          window.setTimeout(() => {
            this.judgeLoad();
          }, 5000);
        }
      });
    },
    callback() {},
    disconnect() {
      if (this.rfidreader) {
        this.rfidreader.Disconnect();
        this.rfidreader = null;
      }
    },
    init() {
      if (this.rfidreader) {
        this.disconnect();
      }
      if (typeof YOWORFIDReader != "undefined" && YOWORFIDReader) {
        this.rfidreader = YOWORFIDReader.createNew();
        if (!this.rfidreader.TryConnect()) {
          this.$message({
            showClose: true,
            message: "浏览器不支持友我科技RFID云服务，请更换浏览器后重试！",
            type: "error"
          });
        }
        this.rfidreader.onResult(resultdata => {
          let arr = [0, 3, 5, 6];
          if (arr.includes(resultdata.FunctionID)) {
            this.callback(resultdata);
            console.log("友我抛出", resultdata);
            this.$emit("resultdata", resultdata);
          }
        });
        if (this.type == 0) {
          this.cardNumber();
        }
        this.isInstall = true;
        this.$emit("onInstall", true);
      }
    },
    // readIDCard() {
    //   this.tips(
    //     () => {
    //       this.rfidreader.Repeat = 0;
    //       this.rfidreader.HaltAfterSuccess = 0;
    //       this.rfidreader.RequestChinaIDCardNo();
    //     },
    //     () => {
    //       this.$message({
    //         showClose: true,
    //         message: "创建友我科技RFID云服务连接失败，请先安装！",
    //         type: "error"
    //       });
    //     }
    //   );
    // },
    loadExe() {
      try {
        this.init();
      } catch (e) {
        this.$message({
          showClose: true,
          message: "创建友我科技RFID云服务连接失败，请先安装！",
          type: "error"
        });
        window.setTimeout(() => {
          this.judgeLoad();
        }, 10000);
      }
    },

    cardNumber() {
      if (!this.rfidreader) {
        this.init();
      }
      this.rfidreader.Repeat = 1;
      this.rfidreader.HaltAfterSuccess = 1;
      this.rfidreader.RequestTypeACardNo(0, 0);
    },
    getErrStr(ErrCode) {
      var ErrText = "";
      switch (ErrCode) {
        case -1:
          ErrText = "没有找到IC卡读卡器，支持型号：YW-605HA或者YW-607";
          break;
        case -3:
          ErrText = "寻卡失败或卡已经休眠,请拿离开读卡器，再放上";
          break;
        case -4:
          ErrText = "寻卡失败";
          break;
        case -5:
          ErrText = "卡休眠失败";
          break;
        case -6:
          ErrText = "密钥认证失败";
          break;
        case -7:
          ErrText = "读块失败";
          break;
        case -8:
          ErrText = "写块失败";
          break;
        case -9:
          ErrText = "钱包初始化失败";
          break;
        case -10:
          ErrText = "钱包读余额失败";
          break;
        case -11:
          ErrText = "钱包充值失败";
          break;
        case -12:
          ErrText = "钱包减值失败";
          break;
        case -13:
          ErrText = "复位错误";
          break;
        case -14:
          ErrText = "COS执行错误";
          break;
        case -101:
          ErrText = "参数错误";
          break;
        case -102:
          ErrText = "DES校验错误";
          break;
        case -103:
          ErrText = "读卡器不支持";
          break;
        case -600:
          ErrText = "没找到YW-602系列UHF读卡器";
          break;
        case -601:
          ErrText = "寻G2标签失败";
          break;
        case -602:
          ErrText = "读G2标签失败";
          break;
        case -603:
          ErrText = "写G2标签失败";
          break;
        case -604:
          ErrText = "执行失败";
          break;
      }
      return ErrText;
    },
    // 修改卡密码
    writeBlock(obj, callback) {
      console.log("obj", obj);
      this.rfidreader.KeyMode = 0;
      this.rfidreader.KeyStringMode = 0;
      this.rfidreader.KeyString = setting.defaultDesKey;
      this.rfidreader.Repeat = 0;
      this.rfidreader.BeepOnSuccess = 0;
      let key = 0;
      let time = null;
      this.callback = function(data) {
        if (data.FunctionID == 6) {
          clearTimeout(time);
          time = setTimeout(() => {
            if (callback) {
              callback();
            }
          }, 3000);
          key++;
          console.log(setting.fans.length + " data " + key, data);
          if (key >= setting.fans.length) {
            clearTimeout(time);
            if (callback) {
              callback();
            }
          }
        }
      };
      setting.fans.forEach(index => {
        console.log("index", index);
        this.rfidreader.M1WriteBlock(
          index * 4 + 3,
          obj.pwda + "FF078069" + obj.pwdb,
          0
        );
      });
    },
    cardEmpty(order) {
      console.log("cardEmpty", order);
      this.rfidreader.DesDir = 0;
      this.rfidreader.Repeat = 0;
      this.rfidreader.BeepOnSuccess = 0;
      this.rfidreader.HaltAfterSuccess = 0;
      this.rfidreader.KeyMode = 0;
      this.rfidreader.KeyStringMode = 0;
      this.rfidreader.KeyString = order.pwda;
      this.callback = () => {};
      setting.sectors.forEach(obj => {
        console.log("obj", obj);
        this.rfidreader.M1WriteBlock(
          obj[0],
          "00000000000000000000000000000000",
          0
        );
        this.rfidreader.M1WriteBlock(
          obj[1],
          "00000000000000000000000000000000",
          0
        );
      });
      this.rfidreader.M1WriteBlock(
        Number(order.sector) * 4 + 0,
        "00000000000000000000000000000000",
        0
      );
    },
    cardWrite4(order, callback, error) {
      console.log("cardWrite4", order);
      let num = Number(order.sector);
      this.sectors = Object.assign([], setting.sectors);
      this.sectors.splice(num, 1);

      this.rfidreader.DesDir = 0;
      this.rfidreader.Repeat = 0;
      this.rfidreader.BeepOnSuccess = 0;
      this.rfidreader.HaltAfterSuccess = 0;
      this.rfidreader.KeyMode = 0;
      this.rfidreader.KeyStringMode = 0;
      this.rfidreader.KeyString = order.pwda;
      let index = 0;
      this.callback = function(data) {
        if (data.Result > 0 && data.FunctionID == 6) {
          console.log("cardWrite4 " + index, data);
          index++;
          if (index == 2) {
            if (callback) {
              callback();
            }
          }
        } else {
          if (error) {
            error(this.getErrStr(data.Result));
          }
          this.callback = () => {};
        }
      };
      this.rfidreader.M1WriteBlock(num * 4 + 0, order.order0, 0);
      this.rfidreader.M1WriteBlock(num * 4 + 2, order.order2, 0);
    },
    setBeep(a = 3, b = 1, c = 1) {
      this.rfidreader.Beep(a, b, c);
    },
    WriteSector(order, arr, jkhd, error) {
      console.log("WriteSector", arr);
      let num = arr.length;
      this.rfidreader.KeyMode = 0;
      this.rfidreader.KeyStringMode = 0;
      this.rfidreader.KeyString = order.pwda;
      this.rfidreader.DesDir = 0;
      this.rfidreader.Repeat = 0;
      this.rfidreader.BeepOnSuccess = 0;
      this.rfidreader.HaltAfterSuccess = 0;
      let index = 0;
      if (num > 0) {
        this.callback = function(data) {
          if (data.Result > 0 && data.FunctionID == 6) {
            console.log("data", data);
            console.log("index", index);
            index++;
            if (index == num * 2) {
              // this.rfidreader.Beep(3, 1, 1);
              if (jkhd) {
                jkhd();
              }
            }
          } else {
            if (error) {
              console.log("121", 121);
              error(this.getErrStr(data.Result));
              this.callback = function() {};
            }
          }
        };
        for (let i = 0; i < num; i++) {
          let obj = arr[i];
          let cardcode = obj["cardcode"];
          if (cardcode.length % 2 == 0) {
            this.rfidreader.M1WriteBlock(
              this.sectors[i][0],
              obj["authorder1"],
              0
            );
            this.rfidreader.M1WriteBlock(
              this.sectors[i][1],
              obj["authorder2"],
              0
            );
          } else {
            error("卡号不正确");
            break;
          }
        }
      }
    },
    //写卡
    cardWrite(order, arr, jkhd, error) {
      this.tips(
        () => {
          if (this.$config.system.name == "windows") {
            if (!this.rfidreader) {
              this.init();
            }
            this.writeBlock(order, () => {
              this.cardWrite4(
                order,
                () => {
                  this.WriteSector(order, arr, jkhd, error);
                },
                error
              );
            });
          } else {
            if (error) {
              error(
                "当前系统不支持友我科技RFID云服务，不能写卡！目前只支持windows系统"
              );
            }
          }
        },
        () => {
          if (error) {
            error("创建友我科技RFID云服务连接失败，请先安装！");
          }
        }
      );
    },

    cardReading4(order, callback, error) {
      this.rfidreader.DesDir = 0;
      this.rfidreader.Repeat = 0;
      this.rfidreader.BeepOnSuccess = 0;
      this.rfidreader.HaltAfterSuccess = 0;
      this.rfidreader.KeyMode = 0;
      this.rfidreader.KeyStringMode = 0;
      this.rfidreader.KeyString = order.pwda;
      let index = 0;

      let obj = {
        order1: "",
        order2: "",
        authorders: []
      };
      let sector = Number(order.sector);
      this.callback = function(data) {
        if (data.Result > 0 && data.FunctionID == 5) {
          index++;
          if (index == 2) {
            if (callback) {
              obj.order2 = data.strData;
              callback(obj);
            }
          } else {
            let val = data.strData;
            if (val && !/^0+$/.test(val)) {
              obj.order1 = val;
              this.rfidreader.M1ReadBlock(sector * 4 + 2, 0);
            } else {
              if (error) {
                error("当前卡中的协议" + sector + "扇区没有数据");
              }
            }
          }
        } else {
          if (error) {
            console.log("d21", 421);
            error(this.getErrStr(data.Result));
            this.callback = () => {};
          }
        }
      };
      this.rfidreader.M1ReadBlock(sector * 4 + 0, 0);
    },

    readSector(order, obj, hdjk, error) {
      let num = Number(order.sector);
      this.sectors = Object.assign([], setting.sectors);
      this.sectors.splice(num, 1);

      let lengs = this.sectors.length;
      this.rfidreader.KeyMode = 0;
      this.rfidreader.KeyStringMode = 0;
      this.rfidreader.KeyString = order.pwda;
      this.rfidreader.DesDir = 0;
      this.rfidreader.Repeat = 0;
      this.rfidreader.BeepOnSuccess = 0;
      this.rfidreader.HaltAfterSuccess = 0;
      let key = 0;
      let fun = is => {
        let arr = this.sectors[key];
        let i = arr[0];
        if (is) {
          i = arr[1];
        }
        this.rfidreader.M1ReadBlock(i, 0);
        console.log("M1ReadBlock i", i);
      };
      let authorder = "";
      let index = 0;
      this.callback = function(data) {
        if (data.Result > 0 && data.FunctionID == 5) {
          console.log("key", key);
          console.log("authorder", authorder);
          console.log("data.strData", data.strData);
          index++;
          if (index == 2) {
            key++;
            index = 0;
            obj.authorders.push({
              authorder1: authorder,
              authorder2: data.strData
            });
            authorder = "";
            if (key == lengs) {
              // this.rfidreader.Beep(3, 1, 1);
              if (hdjk) {
                hdjk(obj);
              }
            } else {
              fun();
            }
          } else {
            authorder = data.strData;
            fun(true);
          }
        } else {
          if (error) {
            console.log("d431", 232);
            error(this.getErrStr(data.Result));
            this.callback = () => {};
          }
        }
      };
      fun();
    },
    //读卡
    cardReading(order, hdjk, error) {
      this.tips(
        () => {
          if (this.$config.system.name == "windows") {
            if (!this.rfidreader) {
              this.init();
            }
            this.cardReading4(
              order,
              obj => {
                this.readSector(order, obj, hdjk, error);
              },
              error
            );
          } else {
            if (error) {
              error(
                "当前系统不支持友我科技RFID云服务，不能读卡！目前只支持windows系统"
              );
            }
          }
        },
        () => {
          if (error) {
            error("创建友我科技RFID云服务连接失败，请先安装！");
          }
        }
      );
    }
  }
};
</script>
