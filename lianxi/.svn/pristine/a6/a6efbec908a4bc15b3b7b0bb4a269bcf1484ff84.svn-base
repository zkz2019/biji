<template>
  <fel-container title="人脸数据管理" @onQuery="onQuery">
    <template slot="retrieve">
      <fel-retrie type="select" v-model="param.facestate" :selects="personnels"></fel-retrie>
      <fel-retrie
        type="cascader"
        text="选择组织"
        v-model="param.pgid"
        :selects="zzoptions"
        :props="{ checkStrictly: true ,value:'pgid',label:'pgname' }"
      ></fel-retrie>
      <fel-retrie text="请输入" v-model="param.search" placeholder="请输入卡号姓名|手机号搜索"></fel-retrie>
    </template>
    <paging-table
      ref="paging-table"
      interface="/access/v2.0/auth/r/listAccessFace"
      class="heig100"
      @onEjectChange="onEjectChange"
      @onSelection="(d)=>{listArrs=d}"
      :param="param"
      ajaxType="9"
      :list="list"
      :refresh="refresh"
    >
      <span v-for="(v,k) of topButs" :key="k" class="sli but-blue" @click="onClick(v.id, v)">
        <i v-if="v.icon" :class="'ficon-'+v.icon"></i>
        {{v.alias}}
      </span>
      <template v-if="batchButs && batchButs.length > 0">
        <batch-but class="sli but-blue" :list="listArrs" :param="batchButs" @onClick="onBatchClick"></batch-but>
      </template>
    </paging-table>
    <fel-popup title="已授权列表" @close="grant.box=false" :value="grant.box">
      <paging-table
        ref="grant-paging-table"
        :list="grant.list"
        interface="/access/v2.0/auth/t/listAccessFaceAuth"
        :isAll="grant.range == 2? true:false"
        :class="{'cover-up':grant.range == 2}"
        :param="grant.param"
        ajaxType="9"
        @onSelection="(data)=>{grant.listArrs = data}"
        :refresh="grant.refresh"
      >
        <template v-if="grant.batchButs && grant.batchButs.length > 0">
          <div class="full-list" v-show="!grant.list[0].show">
            <el-checkbox
              v-model="grant.range"
              @change="onGrantChange"
              true-label="2"
              false-label="1"
            >跨页全选</el-checkbox>
          </div>
          <batch-but
            class="sli but-blue"
            :type="grant.range"
            :list="grant.listArrs"
            :param="grant.batchButs"
            @onClick="onGrantBatchClick"
          ></batch-but>
        </template>
      </paging-table>
    </fel-popup>
    <fel-popup form width="50%" title="录入人脸" @close="entryClose" :value="entry.box">
      <fel-form
        ref="felForm"
        :button="entry.button"
        @submitForm="submitForm"
        @closeForm="entryClose"
        width="140px"
        :defaultData="entry.data"
        :formData="entry.list"
      ></fel-form>
    </fel-popup>

    <fel-popup title="人员列表" @close="person.box=false" :value="person.box">
      <paging-table
        ref="person-paging-table"
        :list="person.list"
        interface="/access/v2.0/auth/w/listAccessFacePerson"
        :param="person.param"
        @onSelect="onPersonSelect"
        ajaxType="9"
        :refresh="person.refresh"
      >
        <span class="sli">
          <el-input
            clearable
            class="search con-search"
            v-model="person.param.search"
            :placeholder="'输入'+getNumber()+'/姓名/手机号进行检索'"
          ></el-input>
          <fel-button type="primary" @click="onPersonRefresh">查询</fel-button>
        </span>
      </paging-table>
    </fel-popup>
    <com-face @submit="submitFace" v-if="face.box" @close="face.box=false" :value="face.box"></com-face>
  </fel-container>
</template>

<script>
import { mapGetters } from "vuex";
import comFace from "../../common/com-face";
export default {
  components: {
    "com-face": comFace
  },
  data() {
    let $this = this;
    return {
      face: {
        data: {},
        box: false
      },
      person: {
        box: false,
        param: {
          search: ""
        },
        refresh: 0,
        list: [
          {
            name: "序号",
            type: "$index",
            width: "60px"
          },
          {
            name: "姓名",
            prop: "personname"
          },
          {
            name: this.getNumber(),
            prop: "personcode"
          },
          {
            name: "归属组织",
            prop: "personlocation",
            tooltip: true
          },
          {
            name: "手机号",
            prop: "personmobile"
          }
        ]
      },
      entry: {
        box: false,
        button: [
          {
            type: "1",
            name: "取消"
          },
          {
            type: "2",
            name: "开始拍照"
          }
        ],
        data: {},
        list: [
          {
            value: "personcode", //值,
            ref: "personcode",
            name: "录入人员", //名称,
            type: "text", //input输入框的类型 或者 select,
            buts: [
              {
                class: "but-connect",
                title: "搜索人员信息",
                icon: "el-icon-search",
                onClick: this.onEntryClick
              }
            ],
            rules: [
              { required: true, message: "录入人员不能为空！", trigger: "blur" }
            ]
          }
        ]
      },
      grant: {
        isSelectable: true,
        box: false,
        listButs: [
          {
            id: 3,
            alias: "修改"
          },
          {
            id: 4,
            alias: "删除"
          }
        ],
        list: [
          {
            type: "selection",
            selectable(row) {
              return $this.grant.isSelectable;
            }
          },
          {
            name: "序号",
            type: "$index",
            width: "60px"
          },
          {
            name: "门禁位置",
            prop: "aglocation"
          },
          {
            name: "门禁名称",
            prop: "amname"
          },
          {
            name: "门名称",
            prop: "adname"
          },
          {
            name: "读头编号",
            prop: "ahname"
          },
          {
            name: "授权账号",
            prop: "userlogin"
          },
          {
            name: "授权创建时间",
            prop: "aufcdate"
          },
          {
            name: "授权开始时间",
            prop: "aufempsdate"
          },
          {
            name: "开门时间段",
            prop: "aufopenstime",
            formatter(a, b, c) {
              return c.aufopenstime + "~" + c.aufopenetime;
            }
          },
          {
            name: "可开门次数",
            prop: "aufusecount"
          },
          {
            name: "操作",
            width: "100px",
            custom: "buts",
            value() {
              return $this.grant.listButs;
            },
            click(obj, id, value) {
              console.log("buts", obj, id, value);
            }
          }
        ],
        listArrs: [],
        param: {
          facecode: ""
        },
        range: "1",
        refresh: 0,
        batchButs: [
          { id: "3", alias: "修改" },
          { id: "4", alias: "删除" }
        ]
      },
      personnels: [
        {
          id: "1",
          name: "11"
        },
        {
          id: "2",
          name: "22"
        }
      ],
      zzoptions: [],
      param: {
        pgid: "",
        sequence: "",
        sortby: "",
        search: "",
        facestate: ""
      },
      topButs: [
        { id: "1", alias: "录入人脸" },
        { id: "2", alias: "导入" }
      ],
      listArrs: [],
      listButs: [
        {
          id: 1,
          alias: "启用"
        },
        {
          id: 2,
          alias: "停用"
        },
        {
          id: 9,
          alias: "同步"
        },
        {
          id: 4,
          alias: "删除"
        }
      ],
      batchButs: [],
      list: [
        {
          type: "selection"
        },
        {
          name: "序号",
          type: "$index",
          width: "60px"
        },
        {
          name: "姓名",
          prop: "personname"
        },
        {
          name: this.getNumber(),
          prop: "personcode"
        },
        {
          name: "手机号",
          prop: "personmobile"
        },
        {
          name: "归属组织",
          prop: "personlocation",
          width: "110px"
        },
        {
          name: "人脸照片",
          prop: "faceaccesscount",
          custom: "num",
          formatter(obj) {
            let num = obj.row.faceaccesscount;
            if (num) {
              return /^[0-9]*$/.test(num);
            }
            return false;
          },
          value(obj) {
            let num = obj.row.faceaccesscount;
            if (num) {
              return "查看";
            }
            return "/";
          }
        },
        {
          name: "已授权数量",
          prop: "faceaccesscount",
          custom: "num",
          formatter(obj) {
            let num = obj.row.faceaccesscount;
            if (num) {
              return /^[0-9]*$/.test(num);
            }
            return false;
          },
          click(obj, value) {
            $this.grant.param.facecode = obj.facecode;
            $this.grant.box = true;
          }
        },
        {
          name: "状态",
          prop: "facestate",
          custom: "color",
          formatter(obj) {
            return obj.row.facestate;
          }
        },
        {
          name: "操作",
          width: "160px",
          custom: "buts",
          value() {
            return $this.listButs;
          },
          formatter(obj, value, index) {
            if (obj.$index == 2 && value.id == 2) {
              return false;
            }
            return true;
          },
          click(obj, id, value) {
            console.log("buts", obj, id, value);
          }
        }
      ],
      refresh: 0
    };
  },
  methods: {
    ...mapGetters(["getNumber"]),
    onPersonRefresh() {
      this.person.refresh = new Date().getTime();
    },
    onPersonSelect(data) {
      if (data && data.personcode) {
        if (this.$refs.felForm) {
          this.$refs.felForm.resetForm();
          this.$refs.felForm.ruleForm = {
            personcode: data.personcode
          };
        }
        this.person.box = false;
      }
    },
    entryClose() {
      if (this.$refs.felForm) {
        this.$refs.felForm.resetForm();
      }
      this.entry.box = false;
    },
    onEntryClick() {
      this.person.param.search = "";
      this.onPersonRefresh();
      this.person.box = true;
    },
    dataURLtoFile(dataurl, filename) {
      //将base64转换为文件
      var arr = dataurl.split(","),
        mime = arr[0].match(/:(.*?);/)[1],
        type = mime.replace("image/", ""),
        bstr = atob(arr[1]),
        n = bstr.length,
        u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new File([u8arr], filename + "." + type, {
        type: mime
      });
    },
    submitFace(img) {
      let file = this.dataURLtoFile(img, this.face.data.personcode);
      let formData = new FormData();
      formData.append("file", file);
      this.$ajax(
        "/access/v2.0/auth/x/saveAccessFace",
        {
          personcode: this.face.data.personcode
        },
        "7",
        formData,
        true
      )
        .then(res => {})
        .catch(err => {
          this.$message({
            showClose: true,
            message: `[${err.resultCode}] ` + err.resultMsg,
            type: "error"
          });
        });
    },
    //录入人脸 确定
    submitForm(data) {
      this.face.data = data;
      this.face.box = true;
    },
    onClick(key, obj) {
      if (key == 1) {
        this.entry.data = {};
        this.entry.box = true;
      }
    },
    onEjectChange() {
      this.$common.onEjectChange(this.list, "kpgl384");
    },
    getEject() {
      this.$common.getEject(this, "list", "kpgl384");
    },
    onSelectable() {
      return this.isSelectable;
    },
    onGrantChange(val) {
      if (val == 2) {
        this.$refs["grant-paging-table"].clearSelection();
        this.$refs["grant-paging-table"].toggleAllSelection();
        setTimeout(() => {
          this.grant.isSelectable = false;
        }, 100);
      } else {
        this.$refs["grant-paging-table"].clearSelection();
        this.grant.isSelectable = true;
      }
    },
    onGrantBatchClick() {},
    onQuery() {
      console.log("this", this);
    }
  }
};
</script>

<style>
</style>