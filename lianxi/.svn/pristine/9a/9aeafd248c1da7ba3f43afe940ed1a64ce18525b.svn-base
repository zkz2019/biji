<!--  房间列表 -->
<template>
  <el-main>
    <div class="query_main fjglBox_middle">
      <paging-table
        interface="/lock/2/getbuildanalysis"
        :list="ldlist"
        ajaxType="1"
        :paramObj="param"
        :refresh="refresh"
        @onEjectChange="onEjectChange"
      ></paging-table>
      <sqtabel
        :param="detailsParam"
        :listBtn="btnAll.czwsxsqBtn"
        :dialogVisible="sqtabelVisible"
        @beforeClose="sqtabelVisible=false"
        ref="sqtabel"
      />
      <rztjChart :data="rztjdata" :dialogVisible="rztjVisible" @beforeClose="rztjVisible=false" />
    </div>
  </el-main>
</template>

<script>
import Storages from "../../utils/Storage.js"; //缓存工具
import sqtabel from "./dialog/sqtabel";
import rztjChart from "./dialog/rztjchart";
export default {
  props: {
    param: Object,
    btnAll: Object
  },
  components: {
    sqtabel,
    rztjChart
  },
  watch: {
    param(val) {
      this.onRefresh();
    }
  },
  data() {
    var $this = this;
    return {
      refresh: 0,
      rztjdata: {},
      rztjVisible: false,
      detailsParam: {},
      sqtabelVisible: false,
      ldlist: [
        {
          name: "序号",
          type: "$index",
          width: "60px"
        },
        { prop: "agname", name: "名称" },
        { prop: "floorcount", name: "楼栋数" },
        { prop: "publiccount", name: "公共房间" },
        { prop: "roomcount", name: "寝室房间" },
        {
          prop: "rz",
          name: "寝室入住人数",
          template: {
            props: ["scope"],
            computed: {},
            methods: {
              onClick() {
                $this.rztjVisible = true;
                $this.rztjdata = this.scope.row;
              }
            },
            template: `<div><a class="a-click" @click.stop="onClick">{{scope.row.rz}}</a></div>`
          }
        },
        {
          prop: "wsxauth",
          name: "授权未下发名单",
          template: {
            props: ["scope"],
            computed: {},
            methods: {
              onClick() {
                $this.sqtabelVisible = true;
                $this.detailsParam = { agid: this.scope.row.agid };
              }
            },
            template: `<div><a v-if="scope.row.wsxauth!='0'" class="a-click" @click.stop="onClick">{{scope.row.wsxauth}}</a><span v-else>{{scope.row.wsxauth}}</span></div>`
          }
        },
        {
          name: "操作",
          width: "120px",
          template: {
            props: ["scope"],
            computed: {
              listBtn() {
                return $this.btnAll.czwsxsqBtn.entity;
              }
            },
            methods: {
              onClick() {
                this.$confirm("确定要重载未生效授权吗？", "提示", {
                  confirmButtonText: "确定",
                  cancelButtonText: "取消",
                  type: "warning"
                }).then(() => {
                  $this.onClick(this.listBtn.id, this.scope.row.agid);
                });
              }
            },
            template: `<div class="operat-buts"> 
             <el-button type="text" size="small" @click.stop="onClick()">{{listBtn.alias}}</el-button>
            </div>`
          }
        }
      ]
    };
  },
  mounted() {
    this.getEject();
  },
  methods: {
    onClick(ind, obj) {
      if (ind == "570") {
        this.$ajax("/lock/7/reloadfailauthbyagid", { agid: obj }, "1", {}, true)
          .then(res => {
            this.$message({
              message: "重载未生效授权已下发!",
              type: "success"
            });
            this.onRefresh();
          })
          .catch(err => {
            console.log(err);
            this.$message({
              message: `[${err.resultCode}] ` + err.resultMsg,
              type: "error"
            });
          });
      }
    },
    onRefresh() {
      //刷新
      this.refresh = new Date().getTime();
    },
    onEjectChange() {
      this.$common.onEjectChange(this.list, "fjgl38");
    },
    getEject() {
      this.$common.getEject(this, "list", "fjgl38");
    }
  }
};
</script>

<style>
</style>
