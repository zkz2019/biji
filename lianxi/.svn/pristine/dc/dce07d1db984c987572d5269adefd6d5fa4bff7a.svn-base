<template>
  <el-dialog
    title="推送角色管理"
    width="50%"
    :close-on-click-modal="false"
    :before-close="beforeClose"
    :visible.sync="dialogVisible"
  >
    <el-container class="dialog-table6 wh100">
      <el-transfer class="margins" v-model="cities" :titles="['未添加角色','已添加角色']" :data="list"></el-transfer>
    </el-container>
    <div slot="footer" class="dialog-button">
      <el-button @click="beforeClose">取消</el-button>
      <el-button type="primary" @click="dialogSubmitForm">确定</el-button>
    </div>
  </el-dialog>
</template>

<script>
export default {
  props: {
    dialogVisible: Boolean,
    defaultData: Object
  },
  data() {
    let $this = this;
    return {
      cities: [],
      letfList: [],
      trole: []
    };
  },
  created() {
    if (this.defaultData.pushid) {
      this.ingetrole();
      this.ingetpushrole();
    }
  },
  computed: {
    list() {
      return [...this.trole, ...this.letfList];
    }
  },
  watch: {
    dialogVisible(val) {
      if (val) {
        if (this.defaultData.pushid) {
          this.ingetrole();
          this.ingetpushrole();
        }
      }
    }
  },
  methods: {
    ingetrole() {
      this.trole = [];
      this.$ajax(
        "/push/limit/1/getrole",
        {
          pushid: this.defaultData.pushid
        },
        "1"
      )
        .then(res => {
          this.trole = (res.result || []).map(obj => {
            return {
              key: obj.rolename,
              label: obj.rolename
            };
          });
        })
        .catch(err => {});
    },
    ingetpushrole() {
      this.letfList = [];
      this.$ajax(
        "/push/limit/2/getpushrole",
        {
          pushid: this.defaultData.pushid
        },
        "1"
      )
        .then(res => {
          this.letfList = (res.result || []).map(obj => {
            return {
              key: obj.rolename,
              label: obj.rolename
            };
          });
          this.cities = this.letfList.map(obj => obj.key);
        })
        .catch(err => {});
    },
    dialogSubmitForm() {
      if (this.cities && this.cities.length > 0) {
        this.$ajax(
          "/push/limit/3/savepushrole",
          {
            pushid: this.defaultData.pushid
          },
          "1",
          this.cities,
          true
        )
          .then(res => {
            this.$emit("onRefresh");
            this.beforeClose();
            this.$message({
              message: "推送角色修改成功",
              type: "success"
            });
          })
          .catch(err => {
            this.$message({
              showClose: true,
              message: `[${err.resultCode}] ` + err.resultMsg,
              type: "error"
            });
          });
      } else {
        this.$message({
          message: "请添加推送消息角色",
          type: "warning"
        });
      }
    },
    beforeClose() {
      if (this.$refs["felForm"]) {
        this.$refs["felForm"].resetForm();
      }
      this.$emit("beforeClose");
    }
  }
};
</script>
