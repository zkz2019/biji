<template>
  <el-dialog
    title="记录查询"
    width="70%"
    class="instructDialog"
    :close-on-click-modal="false"
    :before-close="beforeClose"
    :visible.sync="dialogVisible"
  >
    <el-container class="dialog-table6 query_main">
      <paging-table
        interface="/access/v2.0/main/k/listAccessOrder"
        :list="list"
        ajaxType="9"
        :param="paramObj"
        :refresh="refresh"
      />
    </el-container>
    <fel-dialog
      title="指令详细列表"
      width="70%"
      minWidth="1000px"
      class="instructDialog"
      append-to-body
      :close-on-click-modal="false"
      :before-close="beforeDetailed"
      :visible.sync="dialogDetailed"
    >
      <el-container class="dialog-table6 query_main">
        <paging-table
          interface="/access/v2.0/main/l/listAccessOrderDetails"
          :list="detailedList"
          ajaxType="9"
          :param="detailedParam"
          :refresh="detailedRefresh"
        >
          <span class="sli but-blue" @click="inReloadgatewayorder">
            <i class="ficon-heavy"></i>重载未生效指令
          </span>
        </paging-table>
      </el-container>
    </fel-dialog>
  </el-dialog>
</template>

<script>
export default {
  props: {
    dialogVisible: Boolean,
    param: Object
  },
  data() {
    let $this = this;
    return {
      detailedList: [
        {
          name: "序号",
          type: "$index",
          width: "60px"
        },
        {
          name: "位置",
          prop: "aglocation"
        },
        {
          name: "门禁名称",
          prop: "amname"
        },
        {
          name: "门名称",
          minWidth: "110px",
          prop: "adname"
        },
        // {
        //   name: "门禁唯一ID",
        //   minWidth: "110px",
        //   prop: "amcode"
        // },

        {
          name: "创建日期",
          minWidth: "110px",
          prop: "aodcdate"
        },
        {
          name: "指令开始日期",
          prop: "aodsdate",
          minWidth: "110px"
        },
        {
          name: "指令结束日期",
          prop: "aodedate",
          minWidth: "110px"
        },
        {
          name: "是否清空服务器指令",
          minWidth: "120px",
          show: true,
          prop: "aodisclear",
          formatter(row) {
            return row.aodisclear == 1 ? "是" : "否";
          }
        },
        {
          name: "处理状态",
          width: "80px",
          template: {
            props: ["scope"],
            methods: {
              getClass() {
                let value = this.scope.row.aodstatus;
                if (value == "处理成功") {
                  return "puc-pg";
                } else if (value == "处理失败") {
                  return "puc-px";
                } else {
                  return "";
                }
              }
            },
            template: `<span :class='getClass()'>{{scope.row.aodstatus}}</span>`
          }
        },
        {
          name: "下发状态",
          width: "80px",
          prop: "aodstate",
          template: {
            props: ["scope"],
            methods: {
              getClass() {
                let value = this.scope.row.aodstate;
                if (value == "下发成功") {
                  return "puc-pg";
                } else if (value == "下发失败") {
                  return "puc-px";
                } else {
                  return "";
                }
              }
            },
            template: `<span :class='getClass()'>{{scope.row.aodstate}}</span>`
          }
        },

        {
          name: "备注",
          width: "90px",
          prop: "aodremark"
        }
      ],
      detailedParam: {
        aoid: ""
      },
      detailedRefresh: 0,
      dialogDetailed: false,

      refresh: 0,
      list: [
        {
          name: "序号",
          type: "$index",
          width: "60px"
        },
        {
          name: "类型",
          prop: "aotype"
        },
        {
          name: "总数量",
          width: "80px",
          prop: "aocount",
          template: {
            props: ["scope"],
            methods: {
              isNumber(num) {
                if (num) {
                  return /^[0-9]*$/.test(num) && num != 0;
                }
                return false;
              },
              onClick() {
                if (this.scope.row.aoid) {
                  if (
                    this.scope.row.aotype.indexOf("清除") >= 0 ||
                    this.scope.row.aotype.indexOf("清空") >= 0
                  ) {
                    $this.detailedList[7].show = false;
                  } else {
                    $this.detailedList[7].show = true;
                  }
                  $this.detailedParam.aoid = this.scope.row.aoid;
                  $this.onDetailedRefresh();
                  $this.dialogDetailed = true;
                }
              }
            },
            template: `<div>
              <span v-if="isNumber(scope.row.aocount)"><a class="a-click" @click.stop="onClick">{{scope.row.aocount}}</a></span>
              <span v-else>{{scope.row.aocount}}</span>
            </div>`
          }
        },

        {
          name: "操作人",
          prop: "userlogin"
        },
        {
          name: "处理成功数",
          width: "100px",
          prop: "aookcount"
        },
        {
          name: "处理失败数",
          width: "100px",
          prop: "aonocount"
        },
        {
          name: "操作日期",
          prop: "aocdate"
        }
      ]
    };
  },
  computed: {
    paramObj() {
      return {
        search: "" // this.param.gotype2
      };
    }
  },
  watch: {
    dialogVisible(val) {
      if (val) {
        this.onRefresh();
      }
    }
  },
  methods: {
    inReloadgatewayorder() {
      if (this.detailedParam.aoid) {
        this.$ajax(
          "/access/v2.0/door/f/reloadAccessDoorOrder",
          { aoid: this.detailedParam.aoid },
          "9",
          {},
          true
        )
          .then(res => {
            this.onDetailedRefresh();
            this.$message({
              message: "重载未生效指令成功",
              type: "success"
            });
          })
          .catch(err => {
            this.$message({
              showClose: true,
              message: `[${err.resultCode}] ` + err.resultMsg,
              type: "error"
            });
          });
      }
    },
    onDetailedRefresh() {
      this.detailedRefresh = new Date().getTime();
    },
    beforeDetailed() {
      this.dialogDetailed = false;
    },
    onRefresh() {
      this.refresh = new Date().getTime();
    },
    beforeClose() {
      this.$emit("beforeClose");
    }
  }
};
</script>

<style>
</style>
