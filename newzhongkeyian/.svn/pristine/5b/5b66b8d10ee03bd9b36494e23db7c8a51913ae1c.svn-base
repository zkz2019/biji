<template>
  <el-container>
    <batch v-if="isBatch" :buts="batchButs" ref="batch" @onReturn="isBatch = false"></batch>
    <fel-container v-else title="批量操作门禁" @onQuery="onQuery" @onReset="onReset">
      <template slot="retrieve">
        <fel-retrie
          type="select"
          :props="{label:'name',value:'id'}"
          v-model="param.sendtype"
          :selects="sendTypes"
        ></fel-retrie>
        <fel-retrie v-model="param.search" :placeholder="'输入'+getNumber()+'/姓名查询'"></fel-retrie>
      </template>
      <paging-table
        interface="/access/v2.0/auth/g/listAccessAuthFace"
        class="heig100"
        :param="param"
        :list="list"
        ajaxType="9"
        :refresh="refresh"
      >
        <span v-if="grant.showBut.right" class="sli but-blue" @click="onClick('02')">
          <i class="ficon-image403"></i>
          批量授权人脸数据
        </span>
        <span v-if="grant.showBut.delRight" class="sli but-blue" @click="onClick('01')">
          <i class="ficon-image403"></i>
          批量删除人脸数据
        </span>
      </paging-table>
      <fel-popup width="80%" :title="grant.title" @close="grant.box=false" :value="grant.box">
        <paging-table
          ref="person-paging-table"
          :list="grant.list"
          interface="/access/v2.0/auth/h/listAccessAuthFaceDetails"
          :param="grant.param"
          ajaxType="9"
          :refresh="grant.refresh"
        >
          <span
            v-for="(v,k) of grant.title == '删除授权列表'?grant.delTopButs:grant.topButs"
            :key="k"
            class="sli but-blue"
            @click="onClick(v.id, v)"
          >
            <i v-if="v.icon" :class="'ficon-'+v.icon"></i>
            {{v.alias}}
          </span>
        </paging-table>
      </fel-popup>
    </fel-container>
    <batchDelRight :dialogVisible="DelVisible" isType="2" @beforeClose="DelVisible=false"></batchDelRight>
  </el-container>
</template>

<script>
import batchDelRight from "./batchDelRightMj";
import { mapGetters } from "vuex";
import batch from "./batch";
export default {
  components: {
    batchDelRight,
    batch,
  },
  data() {
    let $this = this;
    return {
      DelVisible: false,
      sendTypes: [
        {
          id: "",
          name: "全部下发方式",
        },
        {
          id: "1",
          name: "立即下发",
        },
        {
          id: "2",
          name: "延时下发",
        },
      ],
      batchButs: [
        {
          id: 0,
          alias: "清空",
          icon: "empty",
        },
        {
          id: 2,
          alias: "修改",
          icon: "image30",
        },
      ],
      grant: {
        box: false,
        title: "授权列表",
        topButs: [],
        delTopButs: [],
        showBut: {
          right: false,
          delRight: false,
        },
        param: { authid: "" },
        list: [
          {
            name: "序号",
            type: "$index",
            width: "60px",
          },
          {
            name: "门禁位置",
            prop: "aglocation",
          },
          {
            name: "门禁名称",
            prop: "amname",
          },
          {
            name: "门名称",
            prop: "adname",
          },
          {
            name: "读头编号",
            prop: "ahname",
          },
          {
            name: "姓名",
            prop: "personname",
          },
          {
            minWidth: "90px",
            name: this.getNumber(),
            prop: "personcode",
          },

          {
            name: "授权详情",
            minWidth: "90px",
            template: {
              props: ["scope"],
              template: `
            <el-tooltip placement="bottom-end">
              <div slot="content">
              授权开始时间 : {{scope.row.aafldsdate}}<br/>
              授权结束时间 : {{scope.row.aafldedate}}<br/>
              可刷卡次数 : {{scope.row.aafldusecount}}<br/>
              可用时间段 : {{scope.row.aafldopenstime + "~" + scope.row.aafldopenetime}}<br/>
              </div>
            <fel-button size="small" type="text">查看</fel-button>
            </el-tooltip>`,
            },
          },
          // {
          //   minWidth: "110px",
          //   name: "授权开始时间",
          //   prop: "aafldsdate"
          // },
          // {
          //   minWidth: "110px",
          //   name: "授权结束时间",
          //   prop: "aafldedate"
          // },
          // {
          //   minWidth: "92px",
          //   name: "可开门次数",
          //   prop: "aafldusecount"
          // },
          // {
          //   minWidth: "92px",
          //   name: "可用时间段",
          //   prop: "opentime",
          //   formatter(a, b, c) {
          //     return a.aafldopenstime + "~" + a.aafldopenetime;
          //   }
          // },
          {
            name: "授权状态",
            prop: "aafldstatus",
            template: {
              props: ["scope"],
              methods: {
                getClass() {
                  let value = this.scope.row.aafldstatus;
                  if (value == "授权成功") {
                    return "puc-pg";
                  } else if (value == "授权失败") {
                    return "puc-px";
                  } else {
                    return "";
                  }
                },
              },
              template: `<span :class='getClass()'>{{scope.row.aafldstatus}}</span>`,
            },
          },
          {
            name: "下发状态",
            prop: "aafldstate",
            template: {
              props: ["scope"],
              methods: {
                getClass() {
                  let value = this.scope.row.aafldstate;
                  if (value == "下发成功") {
                    return "puc-pg";
                  } else if (value == "下发失败" || value == "授权已删除") {
                    return "puc-px";
                  } else {
                    return "";
                  }
                },
              },
              template: `<span :class='getClass()'>{{scope.row.aafldstate}}</span>`,
            },
          },
          {
            name: "失败原因",
            prop: "aafldremark",
          },
        ],
        refresh: 0,
      },
      isBatch: false,
      param: { search: "", sendtype: "" },
      list: [
        {
          name: "序号",
          type: "$index",
          width: "60px",
        },
        {
          name: "创建时间",
          prop: "aaflcdate",
        },

        {
          name: "授权下发时间",
          prop: "aafldate",
        },
        {
          name: "下发方式",
          prop: "aafltype",
          formatter(a) {
            let map = {
              1: "立即下发",
              2: "延时下发",
            };
            return map[a.aafltype];
          },
        },
        // {
        //   name: "授权类型",
        //   prop: "personlocation",
        //   width: "110px"
        // },
        {
          name: "操作类型",
          prop: "actiontype",
          formatter(row) {
            return row.actiontype == "1" ? "批量授权" : "批量删除授权";
          },
        },
        {
          name: "操作总数",
          prop: "aaflcount",
          custom: "num",
          formatter(obj) {
            let num = obj.row.aaflcount;
            if (num) {
              return /^[0-9]*$/.test(num);
            }
            return false;
          },
          click(obj, value) {
            $this.grant.param.authid = obj.row.aaflid;
            $this.onGrantRefresh();
            if (obj.row.actiontype == "1") {
              $this.grant.title = "授权列表";
            } else {
              $this.grant.title = "删除授权列表";
            }
            $this.grant.box = true;
          },
        },
        {
          name: "操作成功数",
          prop: "aaflokcount",
          width: "110px",
        },
        {
          name: "操作失败数",
          prop: "aaflnocount",
          width: "110px",
        },
        {
          name: "指令成功数",
          prop: "aaflordernocount",
          width: "110px",
        },
        {
          name: "指令失败数",
          prop: "aaflorderokcount",
          width: "110px",
        },
        {
          name: "操作人账号",
          prop: "userlogin",
          width: "110px",
        },
        {
          name: "操作人姓名",
          prop: "username",
          width: "110px",
        },
        {
          name: "操作IP",
          width: "120px",
          prop: "ip",
        },
      ],
      refresh: 0,
      sonmenu: 0,
    };
  },
  created() {
    this.inGetsonmenu();
  },
  methods: {
    ...mapGetters(["getNumber"]),
    inGetsonmenu() {
      this.$ajax("/login/home/2/getsonmenu", {
        fatherid: "868",
      })
        .then((res) => {
          this.sonmenu = 4;
          res.result.forEach((value) => {
            let id = value.entity.id;
            let alias = value.entity.alias;
            if (id == "870") {
              this.grant.topButs.push(value.entity);
            } else if (id == "869") {
              this.grant.showBut.right = true;
              value.entity.alias = "立即下发授权";
              this.batchButs.push(value.entity);
              this.batchButs.push({
                id: "8691",
                alias: "延时下发授权",
                icon: value.entity.icon,
              });
            }
            if (id == "992") {
              this.grant.delTopButs.push(value.entity);
            } else if (id == "991") {
              this.grant.showBut.delRight = true;
            }
          });
        })
        .catch((err) => {
          console.log("err", err);
          if (this.sonmenu < 3) {
            setTimeout(() => {
              this.sonmenu++;
              this.inGetsonmenu();
            }, 1000);
          }
        });
    },
    onEjectChange() {},
    onGrantRefresh() {
      this.grant.refresh = new Date().getTime();
    },
    onClick(key) {
      let url = "/access/v2.0/auth/i/reloadAccessAuthFace";
      let data = {
        authid: this.grant.param.authid,
      };
      if (this.grant.title == "删除授权列表") {
        url = "/access/v2.0/deleteauth/4/reloadAccessAuthFace";
        data = {
          adafid: this.grant.param.authid,
        };
      }
      if (key == 870 || key == 992) {
        this.$confirmCon("确定要" + obj.alias + "吗？", () => {
          this.$ajax(url, data, "9", {}, true)
            .then((res) => {
              this.$message({
                message: obj.alias + "已下发",
                type: "success",
              });
              this.onGrantRefresh();
            })
            .catch((err) => {
              this.$message({
                showClose: true,
                message: `[${err.resultCode}] ` + err.resultMsg,
                type: "error",
              });
            });
        });
      } else if (key == "01") {
        this.DelVisible = true;
      } else if (key == "02") {
        this.isBatch = true;
      }
    },
    onQuery() {
      this.refresh = new Date().getTime();
    },
    onReset() {
      this.param.search = "";
      this.param.sendtype = "";
      this.onQuery();
    },
  },
};
</script>

<style>
</style>