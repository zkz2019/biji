<!-- 建筑树形控件-->
<template>
  <div class="fel-tree">
    <div v-if="treedatas.length == 0" v-loading="loading" class="tree-empty">
      <span v-if="serverText">
        {{serverText}}
        <el-button type="text" size="small" @click.stop="onRefresh(1)">刷新数据</el-button>
      </span>
      <span v-else class="el-table__empty-text">暂无数据</span>
    </div>
    <!-- <span
      v-else-if="treedatas[0][this.nodeKey] == 0"
      @click="onRefresh"
      title="刷新"
      class="float refresh"
    >
      <i class="el-icon-refresh"></i>
    </span>-->
    <el-tree
      ref="tree"
      :data="treedatas"
      :props="defaultProps"
      :check-strictly="checkStrictly"
      render-after-expand
      empty-text
      :expand-on-click-node="false"
      :auto-expand-parent="false"
      @node-click="handleNodeClick"
      @node-expand="nodeExpand"
      @node-collapse="nodeCollapse"
      :load="loadin"
      lazy
      :node-key="nodeKey"
      highlight-current
      :show-checkbox="showCheckbox"
      @check="checkchange"
      :default-expanded-keys="idSets"
    >
      <span v-if="iconName" class="custom-tree-node" slot-scope="scope">
        <span class="tree-icon">
          <i v-if="scope.data[iconName] == ''" class="ficon-jianzhus"></i>
          <i v-else-if="scope.data[iconName] == 1" class="ficon-quyu"></i>
          <i v-else-if="scope.data[iconName] == 2" class="ficon-jianzhu"></i>
          <i v-else-if="scope.data[iconName] == 3" class="ficon-louceng"></i>
          {{ scope.node.label}}
        </span>
      </span>
    </el-tree>
  </div>
</template>

<script>
export default {
  props: {
    checkStrictly: Boolean,
    showCheckbox: {
      type: Boolean,
      default: true
    },
    refresh: Number, //刷新
    interface: String,
    interfaceData: Function,
    defaultProps: {
      type: Object,
      default() {
        return {
          children: "children",
          label: "buildname",
          isLeaf: "isLeaf"
        };
      }
    },
    iconName: {
      type: String,
      default: "buildtype"
    },
    param: {
      type: Object,
      default() {
        return {};
      }
    },
    nodeKey: {
      type: String,
      default: "buildid"
    },
    paramKey: {
      type: String
    },
    ajaxType: {
      // 接口类型
      type: String,
      default: "1"
    },
    idArr: {
      type: Array,
      default() {
        return [];
      }
    } //默认展开的数组
  },
  data() {
    return {
      loading: true,
      treedatas: [],
      serverText: "",
      idSets: this.idArr
    };
  },
  methods: {
    addIdSets(id) {
      if (id) {
        if (id instanceof Array) {
          this.idSets.push(...id);
        } else {
          this.idSets.push(id);
        }
        this.idSets = [...new Set(this.idSets)];
      } else {
        this.idSets = [];
      }
    },
    resetChecked() {
      this.$refs.tree.setCheckedKeys([]);
    },
    nodeExpand(data) {
      this.idSets.push(data[this.nodeKey]);
      this.idSets = [...new Set(this.idSets)];
    },
    nodeCollapse(data) {
      const index = this.idSets.indexOf(data[this.nodeKey]);
      if (index > -1) {
        this.idSets.splice(index, 1);
      }
    },
    //点击切换表格
    handleNodeClick(data, Node) {
      if (!data[this.defaultProps["isLeaf"]]) {
        this.addIdSets(data[this.nodeKey]);
      }
      this.$emit("handleNodeClick", data, Node);
    },
    getCheckedNodes() {
      return this.$refs.tree.getCheckedNodes();
    },
    getCheckedKeys() {
      return this.$refs.tree.getCheckedKeys();
    },
    //多选节点击
    checkchange(data, Nodes) {
      this.$emit("checkchange", data, Nodes);
    },
    //获取树形菜单数据
    getTreeData(node, resolve) {
      this.serverText = "";
      let data = {};
      if (
        node &&
        node.data &&
        (node.data[this.nodeKey] || node.data[this.nodeKey] === 0)
      ) {
        data = node.data;
      }
      if (this.paramKey) {
        data[this.paramKey] = data[this.nodeKey] || "";
      }
      this.$ajax(this.interface, this.param, this.ajaxType, data)
        .then(res => {
          this.loading = false;
          let aa = res.result.map(item => {
            if (item.isnext == 1) {
              item.isLeaf = false;
            } else {
              item.isLeaf = true;
            }
            return item;
          }); //过滤
          if (this.interfaceData) {
            this.interfaceData(aa);
          }
          if (!node || !node.data || node.data.length == 0) {
            if (this.idArr.length === 1) {
              const index = this.idArr[0];
              const key = aa[index][this.nodeKey];
              this.idSets[index] = key;
              if (typeof node != "undefined") {
                setTimeout(() => {
                  this.setCurrentKey(key);
                  this.$emit("handleNodeClick", aa[index], node);
                }, 0);
              }
            }
            this.treedatas = aa;
          } else {
            return resolve(aa);
          }
        })
        .catch(err => {
          node.loaded = false;
          node.loading = false;
          this.loading = false;
          if (!node || !node.data || node.data.length == 0) {
            this.serverText = `[${err.resultCode}] ` + err.resultMsg;
          }
        });
    },
    //生成子菜单
    loadin(node, resolve) {
      this.getTreeData(node, resolve);
    },
    setCurrentKey(key) {
      if (this.$refs.tree) {
        this.$refs.tree.setCurrentKey(key);
      }
    },
    onRefresh(key) {
      this.loading = true;
      if (key == 1) {
        let obj = {};
        obj[this.nodeKey] = 0;
        this.getTreeData(obj);
      } else {
        this.getTreeData();
      }
    }
  },
  watch: {
    refresh() {
      this.onRefresh();
    }
  }
};
</script>
