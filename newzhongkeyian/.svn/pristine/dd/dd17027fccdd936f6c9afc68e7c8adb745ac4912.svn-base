<!--  -->
<template>
  <div>
    <doorProhibit
      ref="doorProhibit"
      :title="'已授权门禁权限 - '+param.userlogin"
      top="10vh"
      treeUrl="/system/user/access/1/listUserAccessTree"
      tabelurl="/system/user/access/2/listUserAccessDoor"
      :dialogVisible="dialogVisible"
      @handleClose="handleClose"
      :param="param"
      :list="listOrgani"
      :button="buttons"
      :refresh="refresh"
      @onSelection="onSelection"
      @checkchange="checkchange"
      @onClick="onClick"
      :checkStrictly="true"
    ></doorProhibit>
    <!-- /system/user/supergroup/save/2/getsavesupergroupmanagers -->
    <doorProhibit
      :title="'添加门禁授权 - '+param.userlogin"
      top="10vh"
      treeUrl="/system/user/access/3/listSaveUserAccessTree"
      tabelurl="/system/user/access/4/listSaveUserAccessDoor"
      :dialogVisible="dialogOrganiAdd"
      @handleClose="dialogOrganiAdd=false"
      :checkStrictly="true"
      :next="false"
      prop="agid"
      :param="addParam"
      :list="listOrganiAdd"
      :button="buttonAdds"
      @onSelection="onSelectionAdd"
      @checkchange="checkchangeAdd"
      @onClick="onClick"
    ></doorProhibit>
    <rightList :dialogVisible="rightVisible" @beforeClose="rightVisible=false" types="4"></rightList>
  </div>
</template>

<script>
import { mapGetters } from "vuex";
import doorProhibit from "./doorProhibit";
import rightList from "./dialog/rightList";
export default {
  components: {
    doorProhibit,
    rightList
  },
  props: {
    dialogVisible: Boolean,
    param: Object,
    buttons: Array
  },
  data() {
    return {
      rightVisible: false,
      addParam: {
        userlogin: this.param.userlogin,
        search: "",
        sequence: "",
        sortby: "",
        amstate: ""
      },
      refresh: 0,
      // buttons: [
      //   { type: "z1", name: "删除权限" },
      //   { type: "z2", name: "添加权限" }
      // ],
      buttonAdds: [{ type: "a1", icon: "image622", name: "新增授权" }],
      dialogOrganiAdd: false,
      listOrganiAdd: [
        {
          type: "selection"
        },
        {
          name: "序号",
          type: "$index",
          width: "60px"
        },
        {
          name: "门禁位置",
          sortable: "custom",
          prop: "aglocation",
          formatter(row, obj, data) {
            return row.aglocation + "-" + row.amname;
          }
        },
        {
          name: "门名称",
          sortable: "custom",
          prop: "adname"
        },
        {
          name: "门禁状态",
          sortable: "custom",
          prop: "amstate",
          template: {
            props: ["scope"],
            methods: {
              getClass() {
                let value = this.scope.row.amstate;
                if (value == "在线") {
                  return "puc-pg";
                } else if (value == "离线") {
                  return "puc-px";
                } else {
                  return "";
                }
              }
            },
            template: `<span :class='getClass()'>{{scope.row.amstate}}</span>`
          }
        }
      ],
      listOrgani: [
        {
          type: "selection"
        },
        {
          name: "序号",
          type: "$index",
          width: "60px"
        },
        {
          name: "门禁位置",
          prop: "aglocation",
          sortable: "custom",
          formatter(row, obj, data) {
            return row.aglocation + "-" + row.amname;
          }
        },
        {
          name: "授权人",
          sortable: "custom",
          prop: "userlogin"
        },
        {
          name: "授权时间",
          sortable: "custom",
          prop: "admcdate"
        },
        {
          name: "门名称",
          sortable: "custom",
          prop: "adname"
        },
        {
          name: "门禁状态",
          sortable: "custom",
          prop: "amstate",
          template: {
            props: ["scope"],
            methods: {
              getClass() {
                let value = this.scope.row.amstate;
                if (value == "在线") {
                  return "puc-pg";
                } else if (value == "离线") {
                  return "puc-px";
                } else {
                  return "";
                }
              }
            },
            template: `<span :class='getClass()'>{{scope.row.amstate}}</span>`
          }
        }
      ],
      leftArrs: [],
      arrs: [],
      leftArrsAdd: [],
      arrsAdd: []
    };
  },
  methods: {
    ...mapGetters(["getNumber"]),
    onRefresh() {
      this.arrs = [];
      this.leftArrs = [];
      this.refresh = new Date().getTime();
    },
    handleClose() {
      this.arrs = [];
      this.leftArrs = [];
      this.$emit("handleClose");
    },
    onSelection(data) {
      this.arrs = data;
    },
    onSelectionAdd(data) {
      this.arrsAdd = data;
    },
    checkchange(data, Nodes) {
      this.leftArrs = Nodes.checkedNodes;
    },
    checkchangeAdd(data, Nodes) {
      this.leftArrsAdd = Nodes.checkedNodes;
    },
    inDeleteuserroom(state) {
      this.$confirm("此操作将删除勾选的权限, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      })
        .then(() => {
          let obj1 = this.leftArrs
            ? this.leftArrs.map(o => {
                return { agid: o.agid, agtype: o.agtype };
              })
            : [];
          let obj2 = this.arrs ? this.arrs.map(o => o.admid + "") : [];
          let obj = { areas: [...obj1], admids: [...obj2] };
          // let obj = { areas: 0, admids: 0 };
          this.$ajax(
            "/system/user/access/6/delUserAccessDoor",
            { userlogin: this.param.userlogin, amstate: state },
            "9",
            obj,
            true,
            30000
          )
            .then(res => {
              this.$refs.doorProhibit.param.agid = "0";
              this.onRefresh();
              this.$message({
                showClose: true,
                message: "删除成功",
                type: "success"
              });
            })
            .catch(err => {
              this.$message({
                showClose: true,
                message: `[${err.resultCode}] ` + err.resultMsg,
                type: "error"
              });
            });
        })
        .catch(() => {});
    },

    inSaveuserroom() {
      let obj1 = this.leftArrsAdd
        ? this.leftArrsAdd.map(o => {
            return { agid: o.agid, agtype: o.agtype };
          })
        : [];
      let obj2 = this.arrsAdd ? this.arrsAdd.map(o => o.adid + "") : [];
      let obj = { areas: [...obj1], adids: [...obj2] };
      // if (obj[0] == "0") {
      // obj.shift();
      // }
      // {
      //   grouplist: this.leftArrsAdd
      //     ? this.leftArrsAdd.map(o => o.agid + "")
      //     : [],
      //   personlist: this.arrsAdd ? this.arrsAdd.map(o => o.personcode) : []
      // };
      this.$ajax(
        "/system/user/access/5/saveUserAccessDoor",
        { userlogin: this.param.userlogin },
        "9",
        obj,
        true,
        120000
      )
        .then(res => {
          this.$message({
            showClose: true,
            message: "添加成功",
            type: "success"
          });
          this.dialogOrganiAdd = false;
          this.onRefresh();
        })
        .catch(err => {
          this.$message({
            showClose: true,
            message: `[${err.resultCode}] ` + err.resultMsg,
            type: "error"
          });
        });
    },
    onClick(key, state) {
      if (key == "892") {
        this.arrsAdd = [];
        this.leftArrsAdd = [];
        this.addParam = {
          userlogin: this.param.userlogin,
          agid: "0",
          agtype: "0",
          search: "",
          sequence: "",
          sortby: "",
          amstate: ""
        };
        this.dialogOrganiAdd = true;
      } else if (key == "893") {
        if (this.arrs.length > 0 || this.leftArrs.length > 0) {
          this.inDeleteuserroom(state);
        } else {
          this.$message({
            message: "请选择要删除的权限!",
            type: "warning"
          });
        }
      } else if (key == "a1") {
        if (this.arrsAdd.length > 0 || this.leftArrsAdd.length > 0) {
          this.inSaveuserroom();
        } else {
          this.$message({
            message: "请选择要添加的权限!",
            type: "warning"
          });
        }
      } else if (key == "894") {
        this.rightVisible = true;
      }
    }
  }
};
</script>
