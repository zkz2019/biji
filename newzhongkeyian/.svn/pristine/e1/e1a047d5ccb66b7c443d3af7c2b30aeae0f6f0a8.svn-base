<template>
  <el-dialog
    class="grant"
    top="5%"
    title="授权管理"
    width="1050px"
    :close-on-click-modal="false"
    :before-close="beforeClose"
    :visible.sync="dialogVisible"
  >
    <!-- <el-header class="query_headbox">
    </el-header>-->
    <el-main class="padt0 query_main">
      <retrieval class="query_head marpadbor0">
        <inpbox :inpb="true">
          <el-select class="con-select qh_inp" v-model="param.authtype">
            <el-option v-for="item in authtypes" :key="item.id" :label="item.name" :value="item.id"></el-option>
          </el-select>
        </inpbox>
        <inpbox :inpb="true">
          <el-select class="con-select qh_inp" v-model="param.issend">
            <el-option v-for="item in issends" :key="item.id" :label="item.name" :value="item.id"></el-option>
          </el-select>
        </inpbox>
        <inpbox :inpb="true">
          <el-select class="con-select qh_inp" v-model="param.ahid">
            <el-option v-for="item in ahids" :key="item.id" :label="item.name" :value="item.id"></el-option>
          </el-select>
        </inpbox>
        <inpbox :inpb="true">
          <el-input
            clearable
            class="con-search qh_inp"
            v-model="param.search"
            :placeholder="'请输入'+getNumber()+'/身份证查询'"
          ></el-input>
        </inpbox>
        <inpbox>
          <fel-button class="qh_btn" type="primary" @click="onRefresh">查询</fel-button>
          <fel-button class="qh_btn" @click="onReset">重置</fel-button>
        </inpbox>
      </retrieval>
      <paging-table
        class="tobleList wh100"
        interface="/access/v2.0/door/g/listAccessAuth"
        :list="list"
        :refresh="refresh"
        ref="paging-table"
        :paramObj="paramList"
        ajaxType="9"
        :isAll="range == 2? true:false"
        :class="{'cover-up':range == 2}"
        @onRefreshTable="onRefresh"
        @onSelection="(d)=>{selecArr=d}"
      >
        <template>
          <span v-for="(v,k) of topButs" :key="k" class="sli but-blue" @click="onClick(v.id, v)">
            <i v-if="v.icon" :class="'ficon-'+v.icon"></i>
            {{v.alias}}
          </span>
          <template v-if="batchButs.length > 0">
            <div class="full-list" v-show="!list[0].show">
              <el-checkbox v-model="range" @change="onChange" true-label="2" false-label="1">跨页全选</el-checkbox>
            </div>
            <batch-but
              class="sli but-blue"
              :type="range"
              :list="selecArr"
              :param="batchButs"
              @onClick="onAction"
            ></batch-but>
          </template>
        </template>
      </paging-table>
    </el-main>
    <grantAdd
      :param="paramObj"
      @onRefresh="onRefresh"
      @beforeClose="dialogAdd=false"
      :dialogVisible="dialogAdd"
    ></grantAdd>
    <grantModify
      :param="modifyParam"
      :defaultData="defaultDataModify"
      @onRefresh="onRefresh"
      @beforeClose="dialogModify=false"
      :dialogVisible="dialogModify"
    ></grantModify>
    <record :paramObj="paramObj" :dialogVisible="dialogRecord" @beforeClose="dialogRecord=false"></record>
  </el-dialog>
</template>

<script>
import { mapGetters } from "vuex";
import grantAdd from "./grantAdd";
import record from "./record";
import grantModify from "./grantModify";
export default {
  components: {
    grantAdd,
    record,
    grantModify
  },
  props: {
    paramObj: Object,
    btnRight: {
      type: Array,
      default: () => {
        return [];
      }
    },
    dialogVisible: Boolean
  },
  data() {
    let $this = this;
    return {
      dialogAdd: false,
      dialogModify: false,
      dialogRecord: false,
      refresh: 0,
      param: {
        search: "",
        authtype: "",
        issend: "",
        ahid: ""
      },
      defaultDataModify: {},
      modifyParam: {},
      authtypes: [],
      ahids: [],
      issends: [],
      selecArr: [],
      list: [
        {
          type: "selection",
          selectable: this.onSelectable
        },
        {
          name: "序号",
          type: "$index",
          width: "50px"
        },
        {
          name: "下发日期",
          prop: "senddate",
          width: "110px"
        },
        {
          name: "归属人",
          width: "65px",
          prop: "personname"
        },
        {
          name: this.getNumber(),
          prop: "personcode",
          minWidth: "80px"
        },
        {
          name: "归属人组织",
          prop: "personlocation",
          minWidth: "95px"
        },
        {
          name: "授权类型",
          prop: "authtypename",
          width: "80px"
        },
        {
          name: "授权详情",
          width: "80px",
          prop: "cardcode"
        },
        {
          name: "卡片类型",
          width: "80px",
          prop: "cardtype"
        },
        {
          name: "读头编号",
          width: "80px",
          prop: ""
        },
        {
          name: "授权账号",
          width: "80px",
          prop: "userlogin"
        },
        {
          name: "下发状态",
          prop: "issend",
          template: {
            props: ["scope"],
            methods: {
              getClass() {
                let value = this.scope.row.issend;
                if (value == "下发成功") {
                  return "puc-pg";
                } else if (value == "下发失败") {
                  return "puc-px";
                } else {
                  return "";
                }
              }
            },
            template: `<span :class="getClass()">{{scope.row.issend}}</span>`
          }
        },
        {
          name: "指令备注",
          prop: "failtype"
        },
        {
          name: "操作",
          width: "130px",
          template: {
            props: ["scope"],
            computed: {
              listBut() {
                return $this.batchButs;
              }
            },
            methods: {
              onClick(key, obj) {
                if (key == 846) {
                  $this.modify(this.scope.row);
                } else if (key == 848) {
                  $this.heavyLoad(this.scope.row);
                } else if (key == 847) {
                  $this.delete(this.scope.row);
                }
              }
            },
            template: `<div class="operat-buts">
             <fel-button v-for="(v,i) of listBut" :key="i" type="text" size="small" @click.stop="onClick(v.id, v)">{{v.alias}}</fel-button>
            </div>`
          }
        }
      ],
      range: "1",
      ranges: [
        {
          value: "1",
          label: "勾选范围"
        },
        {
          value: "2",
          label: "全部列表"
        }
      ]
    };
  },
  computed: {
    paramList() {
      let obj = {
        adid: this.paramObj.adid,
        amid: this.paramObj.amid,
        ahid: this.param.ahid,
        authtype: this.param.authtype,
        issend: this.param.issend,
        search: this.param.search
      };
      return obj;
    },
    topButs() {
      let arr = [];
      this.btnRight.forEach(item => {
        if (item.entity.id == "845") {
          arr.push(item.entity);
        } else if (item.entity.id == "849") {
          arr.push(item.entity);
        }
      });
      return arr;
    },
    batchButs() {
      let arr = [];
      this.btnRight.forEach(item => {
        if (item.entity.id == "846") {
          arr.push({ id: item.entity.id, alias: item.entity.alias });
        } else if (item.entity.id == "847") {
          arr.push({ id: item.entity.id, alias: item.entity.alias });
        } else if (item.entity.id == "848") {
          arr.push({ id: item.entity.id, alias: item.entity.alias });
        }
      });
      return arr;
    },
    actionParam() {
      let data = {
        // actiontype: this.range == "2" ? "全选范围" : "勾选范围",
        // auths: this.selecArr,
        adid: this.paramObj.adid,
        ahid: this.param.ahid,
        amid: this.paramObj.amid,
        authtype: this.param.authtype,
        issend: this.param.issend,
        search: this.param.search
      };
      return data;
    }
  },
  created() {
    console.log("this.paramObj", this.paramObj);
  },
  watch: {
    dialogVisible(val) {
      if (val) {
        this.$ajax(
          "/access/v2.0/door/h/getSearchType",
          { adid: this.paramObj.adid },
          "9"
        )
          .then(res => {
            this.ahids = res.result.ahids;
            this.authtypes = res.result.authtypes;
            this.issends = res.result.issends;
            console.log("res", res);
          })
          .catch(err => {
            console.log("err", err);
          });
      }
    }
  },
  mounted() {},
  methods: {
    ...mapGetters(["getNumber"]),
    beforeClose() {
      this.$emit("beforeClose");
    },
    onRefresh() {
      this.refresh = new Date().getTime();
    },
    onReset() {
      Object.keys(this.param).forEach(key => {
        this.param[key] = "";
      });
      this.onRefresh();
    },
    onChange(val) {
      if (val == 2) {
        this.$refs["paging-table"].clearSelection();
        this.$refs["paging-table"].toggleAllSelection();
        setTimeout(() => {
          this.isSelectable = false;
        }, 100);
      } else {
        this.$refs["paging-table"].clearSelection();
        this.isSelectable = true;
      }
    },
    onAction(val, obj) {
      if (val == 846) {
        this.modify();
      } else if (val == 847) {
        this.delete();
      } else if (val == 848) {
        this.heavyLoad();
      }
    },
    onClick(id, data) {
      if (id == "845") {
        this.dialogAdd = true;
      } else if (id == "849") {
        this.dialogRecord = true;
      }
    },
    heavyLoad(obj) {
      this.$confirm("确定要重载当前授权吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      }).then(() => {
        let data = {};
        if (obj) {
          data = {
            actiontype: "勾选范围",
            auths: [obj]
          };
        } else {
          data = {
            actiontype: this.range == "2" ? "全选范围" : "勾选范围",
            auths: this.selecArr
          };
        }

        this.$ajax(
          "/access/v2.0/door/i/reloadAccessAuth",
          this.actionParam,
          "9",
          data
        )
          .then(res => {
            this.$message({
              type: "success",
              message: "重载成功!"
            });
          })
          .catch(err => {
            this.$message({
              type: "error",
              message: `[${err.resultCode}] ` + err.resultMsg || "重载失败!"
            });
          });
      });
    },
    modify(obj) {
      if (obj) {
        this.$ajax(
          "/access/v2.0/door/k/getAccessAuthInfo",
          { auid: obj.auid, authtype: obj.authtype },
          "9"
        )
          .then(res => {
            this.defaultDataModify = res.result;
            console.log("res", res);
          })
          .catch(err => {
            console.log("err", err);
          });
        this.modifyParam = {
          actiontype: "勾选范围",
          auths: [obj],
          ...this.actionParam
        };
      } else {
        this.modifyParam = {
          actiontype: this.range == "2" ? "全选范围" : "勾选范围",
          auths: this.selecArr,
          ...this.actionParam
        };
      }
      this.dialogModify = true;
    },
    delete(obj) {
      this.$confirm("确定要删除当前授权吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      }).then(() => {
        this.$ajax(
          "/access/v2.0/door/l/deleteAccessAuth",
          this.actionParam,
          "9"
        )
          .then(res => {
            this.$message({
              type: "success",
              message: "删除成功!"
            });
          })
          .catch(err => {
            this.$message({
              type: "error",
              message: `[${err.resultCode}] ` + err.resultMsg || "删除失败!"
            });
          });
      });
    }
  }
};
</script>

<style lang="scss">
.grant {
  .query_main {
    height: 450px;
    .con-select {
      width: 120px;
    }
    .con-search {
      width: 150px;
    }
  }
}
</style>