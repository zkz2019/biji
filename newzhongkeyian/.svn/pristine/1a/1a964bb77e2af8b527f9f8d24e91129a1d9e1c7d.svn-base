<template>
  <el-dialog
    title="导入历史"
    width="70%"
    class="importHistory"
    :close-on-click-modal="false"
    append-to-body
    :before-close="beforeClose"
    :visible.sync="dialogVisible"
  >
    <el-container class="dialog-table6 wh100">
      <el-header class="query_headbox">
        <retrieval class="query_head">
          <inpbox inptext="导入类型">
            <el-select class="wid100p qh_inp" v-model="param.type">
              <el-option v-for="(item,ind) in types" :key="ind" :label="item.name" :value="item.id"></el-option>
            </el-select>
          </inpbox>
          <inpbox inptext="请输入">
            <el-input
              clearable
              class="qh_w270 qh_inp maR24"
              v-model="param.search"
              :placeholder="'输入'+getNumber()+'/工号/姓名进行检索'"
            ></el-input>
          </inpbox>
          <inpbox>
            <fel-button class="qh_btn" type="primary" @click="search">查询</fel-button>
            <fel-button class="qh_btn" @click="onReset">重置</fel-button>
          </inpbox>
        </retrieval>
      </el-header>
      <paging-table
        interface="/lock/upload/e/getupload"
        :list="list"
        :param="param"
        :refresh="refresh"
      />
    </el-container>
    <importDetails
      :dialogDetailed="dialogDetailed"
      :uploadid="param1.uploadid"
      :listObj="listObj"
      @beforeDetailed="beforeDetailed"
    ></importDetails>
  </el-dialog>
</template>

<script>
import importDetails from "./import-details";
import { download } from "@/utils/utils.js";
import { mapGetters } from "vuex";
export default {
  props: {
    dialogVisible: Boolean,
    uploadid: String | Number
  },
  components: { importDetails },
  data() {
    let $this = this;
    return {
      failUrl: "",
      types: [
        { id: "1,2,3,4,5,6", name: "全部" },
        { id: "1", name: "入住导入" },
        { id: "2", name: "退宿导入" },
        { id: "3", name: "比对导入" },
        {
          id: "4",
          name: (this.getRoomtype2()()[2] || "公共房间") + "授权导入"
        },
        {
          id: "7",
          name: (this.getRoomtype2()()[2] || "公共房间") + "删除导入"
        },
        { id: "8", name: (this.getRoomtype2()()[2] || "公共房间") + "比对导入" }
      ],
      refresh: 0,
      detailedRefresh: 0,
      dialogDetailed: false,
      param: { type: "", search: "" },
      param1: { uploadid: "" },
      getRoomtype2s: {},
      interface1: "/lock/upload/f/getuploadauth",
      listObj: {},
      list: [
        {
          name: "序号",
          type: "$index",
          width: "60px"
        },
        {
          name: "操作时间",
          width: "150px",
          prop: "uploaddate"
        },
        {
          name: "类别",
          prop: "uploadtype",
          width: "80px",
          template: {
            props: ["scope"],
            computed: {
              type() {
                if (this.scope.row.uploadtype) {
                  let name = "";
                  $this.types.forEach(item => {
                    if (item.id == this.scope.row.uploadtype) {
                      console.log("item", item.name, this.scope.row.uploadtype);
                      name = item.name;
                    }
                  });
                  return name;
                  //   if (this.scope.row.uploadtype == "1") {
                  //     return "入住导入";
                  //   } else if (this.scope.row.uploadtype == "2") {
                  //     return "退宿导入";
                  //   } else if (this.scope.row.uploadtype == "3") {
                  //     return "比对导入";
                  //   } else if (this.scope.row.uploadtype == "4") {
                  //     return (
                  //       (this.getRoomtype2()()[2] || "公共房间") + "授权导入"
                  //     );
                  //   }
                } else {
                  return "";
                }
              }
            },
            template: `<div>
              <span>{{type}}</span>
            </div>`
          }
        },
        {
          name: "导入数量",
          prop: "uploadallcount",
          width: "100px"
        },
        {
          name: "进度",
          prop: "uploadallcount",
          width: "100px",
          formatter(row, b, c, d) {
            if (row) {
              let newtotal =
                Number(row.uploadnocount) + Number(row.uploadokcount);
              let total = Number(row.uploadallcount);
              return Math.floor((newtotal / total) * 100) + "%";
            } else {
              return "";
            }
          }
        },
        {
          name: "正在导入数",
          prop: "uploadcount",
          width: "100px"
        },
        {
          name: "导入失败数",
          prop: "uploadnocount",
          width: "100px"
        },
        {
          name: "导入成功数",
          prop: "uploadokcount",
          width: "100px"
        },

        {
          name: "导入账户",
          prop: "userlogin"
        },
        {
          name: "导入姓名",
          prop: "username"
        },

        {
          name: "操作",
          width: "100px",
          template: {
            props: ["scope"],
            computed: {
              listBut() {
                let obj = this.scope.row;
                return [
                  { name: "查看", id: "1", type: obj.uploadtype, data: obj },
                  {
                    name: "导出",
                    id: "2",
                    type: obj.uploadtype,
                    data: obj
                  }
                ];
              }
            },
            methods: {
              onClick(id, obj) {
                $this.onClick(id, obj);
              }
            },
            template: `<div class="operat-buts"> 
             <el-button v-for="(v,i) of listBut" :key="i" type="text" size="small" @click.stop="onClick(v.id, v)">{{v.name}}</el-button>
            </div>`
          }
        }
      ]
    };
  },
  created() {
    this.getRoomtype2s = this.getRoomtype2()();
  },
  computed: {},
  watch: {
    dialogVisible(val) {
      this.onRefresh();
    }
  },
  methods: {
    ...mapGetters(["getNumber", "getRoomtype2"]),
    beforeClose() {
      this.$emit("beforeClose");
    },
    beforeDetailed() {
      this.dialogDetailed = false;
    },
    onClick(id, obj) {
      console.log("id,obj", id, obj);
      this.listObj = obj;
      this.param1.uploadid = obj.data.uploadid;
      if (id == "1") {
        this.dialogDetailed = true;
      } else {
        let name = "";
        if (obj.type == "1") {
          this.failUrl = "/lock/upload/i/downuploadauthfail";
          name = "失败入住记录";
        } else if (obj.type == "2") {
          this.failUrl = "/lock/upload/j/downuploadauthbackfail";
          name = "失败退宿记录";
        } else if (obj.type == "3") {
          this.failUrl = "/lock/upload/k/downuploadauthcheckfail";
          name = "失败比对记录";
        } else if (obj.type == "4") {
          this.failUrl = "/lock/upload/p/downuploadauthpublicfail";
          name = "失败" + (this.getRoomtype2s[2] || "公共房间") + "授权记录";
        } else if (obj.type == "7") {
          this.failUrl = "/lock/upload/t/downuploadpublicbackfail";
          name = "失败" + (this.getRoomtype2s[2] || "公共房间") + "删除记录";
        } else if (obj.type == "8") {
          this.failUrl = "";
          name = "失败" + (this.getRoomtype2s[2] || "公共房间") + "比对记录";
        }
        this.exportBut(name);
      }
    },
    search() {
      this.onRefresh();
    },
    onReset() {
      Object.keys(this.param).forEach(item => {
        this.param[item] = "";
      });
      this.onRefresh();
    },
    onRefresh() {
      this.refresh = new Date().getTime();
    },
    //导出
    exportBut(name) {
      let url = this.failUrl;
      let data = { uploadid: this.param1.uploadid };
      this.inExport(url, name, data);
    },
    inExport(url, name, data = {}, obj = {}) {
      this.$ajax(url, data, "8", obj, "文件导出中...", 60000)
        .then(res => {
          if (res.size) {
            download(res, name);
            this.$notify({
              title: "成功",
              message: name + "文件导出成功！",
              type: "success"
            });
          }
        })
        .catch(err => {
          this.$message.error("文件导出失败！失败原因：" + err.resultMsg);
        });
    }
  }
};
</script>

<style lang="scss">
.importHistory {
  .query_head {
    margin: 0;
  }
}
</style>